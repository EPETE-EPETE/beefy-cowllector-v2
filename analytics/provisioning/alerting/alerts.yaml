apiVersion: 1
groups:
    - orgId: 1
      name: Cowllector Alerts
      folder: Cowllector Alerts
      interval: 30m
      rules:
        - uid: f170e2b1-2785-4bbe-8e6e-f5d04ce03780
          title: Cowllector Wallet Native Balance Is Low
          condition: Last balance should alert
          data:
            - refId: all_chains_have_enough_balance
              relativeTimeRange:
                from: 14400
                to: 0
              datasourceUid: PAF11E62F20EEC83B
              model:
                editorMode: code
                format: time_series
                intervalMs: 1000
                maxDataPoints: 43200
                rawQuery: true
                rawSql: |
                  with transaction_max_cost as (
                    select chain, max(transaction_gas_cost_wei) as max_trx_cost
                    FROM harvest_report_vault_details
                    WHERE datetime between now() - '14 day'::interval and now()
                    GROUP BY chain
                  ),
                  balance_ok_by_chain as (
                    select 
                      c.chain,
                      t.max_trx_cost,
                      c.harvest_balance_gas_multiplier_threshold, 
                      r.balance_after_native_wei,
                      (t.max_trx_cost * c.harvest_balance_gas_multiplier_threshold) as balance_threshold_1,
                      c.unwrap_trigger_amount_wei as balance_threshold_2,
                      coalesce(
                        r.balance_after_native_wei > (t.max_trx_cost * c.harvest_balance_gas_multiplier_threshold),
                        r.balance_after_native_wei > c.unwrap_trigger_amount_wei, -- not "right" but a good default
                        false
                      ) as balance_ok
                    FROM transaction_max_cost t 
                    join chain c using (chain)
                    join last_harvest_run_by_chain r using (chain)
                    where not c.eol and c.harvest_enabled
                  )
                  select now() as time, chain, (not balance_ok)::integer as value
                  from balance_ok_by_chain
                refId: all_chains_have_enough_balance
                sql:
                    columns:
                        - parameters: []
                          type: function
                    groupBy:
                        - property:
                            type: string
                          type: groupBy
                    limit: 50
            - refId: Last balance should alert
              relativeTimeRange:
                from: 14400
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 0
                            - 0
                        type: gt
                      operator:
                        type: and
                      query:
                        params: []
                      reducer:
                        params: []
                        type: avg
                      type: query
                datasource:
                    name: Expression
                    type: __expr__
                    uid: __expr__
                expression: all_chains_have_enough_balance
                intervalMs: 1000
                maxDataPoints: 43200
                reducer: last
                refId: Last balance should alert
                type: reduce
          noDataState: NoData
          execErrState: Error
          for: 2h
          isPaused: false
        - uid: df122fcf-c214-4b04-90fa-d3e0cb3c56e8
          title: Vault Harvest Failed
          condition: last vault harvest status
          data:
            - refId: vault_harvest_success_ts
              relativeTimeRange:
                from: 14400
                to: 0
              datasourceUid: PAF11E62F20EEC83B
              model:
                editorMode: code
                format: time_series
                intervalMs: 1000
                maxDataPoints: 43200
                rawQuery: true
                rawSql: |
                    SELECT
                      date_trunc('hour', datetime) as time,
                      vault_id,
                      chain,
                      (not coalesce(r.summary_status != 'error', true)) :: integer as value
                    FROM
                      harvest_report_vault_details r
                    WHERE
                      $__timeFilter(datetime)
                    ORDER BY
                      datetime
                refId: vault_harvest_success_ts
                sql:
                    columns:
                        - parameters: []
                          type: function
                    groupBy:
                        - property:
                            type: string
                          type: groupBy
                    limit: 50
            - refId: last vault harvest status
              relativeTimeRange:
                from: 14400
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 0
                            - 0
                        type: gt
                      operator:
                        type: and
                      query:
                        params: []
                      reducer:
                        params: []
                        type: avg
                      type: query
                datasource:
                    name: Expression
                    type: __expr__
                    uid: __expr__
                expression: vault_harvest_success_ts
                intervalMs: 1000
                maxDataPoints: 43200
                reducer: last
                refId: last vault harvest status
                settings:
                    mode: ""
                type: reduce
          dashboardUid: dad68cbc-f965-4400-9db3-66a3bb4c447e
          panelId: 1
          noDataState: OK
          execErrState: Error
          for: 3h
          annotations:
            __dashboardUid__: dad68cbc-f965-4400-9db3-66a3bb4c447e
            __panelId__: "1"
          labels:
            template: alert_vault_harvest_in_error
          isPaused: false
        - uid: cacdfe7b-8b6e-4304-8dae-be3346e174c2
          title: Run Error Alert
          condition: last value error
          data:
            - refId: cowllector run errors
              relativeTimeRange:
                from: 14400
                to: 0
              datasourceUid: PAF11E62F20EEC83B
              model:
                editorMode: code
                format: time_series
                intervalMs: 1000
                maxDataPoints: 43200
                rawQuery: true
                rawSql: |
                  with run_in_error as (
                    (
                      select 
                        r.datetime,
                        r.chain,
                        'unwrap' as report_type,
                        r.run_ok
                      from last_unwrap_run_by_chain r
                      join chain c using (chain)
                      where c.harvest_enabled and not c.eol
                        and $__timeFilter(datetime) 
                    ) UNION ALL (
                      select 
                        r.datetime,
                        r.chain,
                        'harvest' as report_type,
                        r.run_ok
                      from last_harvest_run_by_chain r
                      join chain c using (chain)
                      where c.harvest_enabled and not c.eol
                        and $__timeFilter(datetime)
                    )
                  )
                  select 
                    date_trunc('hour', datetime) as time, 
                    chain || '-' || report_type as report_key, 
                    (not run_ok)::integer as value
                  from run_in_error r
                  order by datetime
                refId: cowllector run errors
                sql:
                    columns:
                        - parameters: []
                          type: function
                    groupBy:
                        - property:
                            type: string
                          type: groupBy
                    limit: 50
            - refId: last value error
              relativeTimeRange:
                from: 14400
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params:
                            - 0
                            - 0
                        type: gt
                      operator:
                        type: and
                      query:
                        params: []
                      reducer:
                        params: []
                        type: avg
                      type: query
                datasource:
                    name: Expression
                    type: __expr__
                    uid: __expr__
                expression: cowllector run errors
                intervalMs: 1000
                maxDataPoints: 43200
                reducer: last
                refId: last value error
                settings:
                    mode: ""
                type: reduce
          noDataState: OK
          execErrState: Error
          for: 3h
          isPaused: false
        - uid: a238c42c-cd5e-4050-86cf-64ac3a0954c9
          title: Non-profitable unwrap
          condition: last_harvest_profitable
          data:
            - refId: unwrap unprofitable
              relativeTimeRange:
                from: 1209600
                to: 0
              datasourceUid: PAF11E62F20EEC83B
              model:
                editorMode: code
                format: time_series
                intervalMs: 1000
                maxDataPoints: 43200
                rawQuery: true
                rawSql: |
                  with unwrap_not_profitable as (
                    SELECT
                      r.datetime,
                      r.chain,
                      balance_before_native_wei,
                      balance_after_native_wei,
                      (balance_before_native_wei <= balance_after_native_wei) as is_valid,
                      row_number() over (partition by chain order by datetime desc) as row_number
                    FROM
                      cowllector_run r
                    where 
                      report_type = 'unwrap'
                      and balance_before_native_wei is not null 
                      and balance_after_native_wei is not null
                      and $__timeFilter(datetime) 
                  )
                  select 
                    date_trunc('month', datetime) as time,
                    chain,
                    (not bool_and(is_valid)) :: integer as value
                  from
                    unwrap_not_profitable
                  group by 1, 2
                  order by 1
                refId: unwrap unprofitable
                sql:
                    columns:
                        - parameters: []
                          type: function
                    groupBy:
                        - property:
                            type: string
                          type: groupBy
                    limit: 50
            - refId: last_harvest_profitable
              relativeTimeRange:
                from: 21600
                to: 0
              datasourceUid: __expr__
              model:
                conditions:
                    - evaluator:
                        params: []
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                            - B
                      reducer:
                        params: []
                        type: last
                      type: query
                datasource:
                    type: __expr__
                    uid: __expr__
                expression: unwrap unprofitable
                intervalMs: 1000
                maxDataPoints: 43200
                reducer: last
                refId: last_harvest_profitable
                type: reduce
          noDataState: OK
          execErrState: Error
          for: 30m
          isPaused: false

